<section class="Timeline">
  <div class="genre-search-form">
    <%= search_form_for @q do |f| %>
      <%= f.collection_select :genre_id_eq, @genres, :id, :name, :include_blank => 'ジャンル検索' %>
      <%= f.submit %>
    <% end %>
  </div>

  <div class="address-search-form">
    <%= search_form_for @q do |f| %>
    <%= f.search_field :address_cont, placeholder: "場所で検索" %>
    <%= f.submit %>
    <% end %>
  </div>

  <h4>タイムライン</h4>
  <div class="timeline">
  <% @posts.each do |post| %>
    <tr>
    <%= link_to member_path(post.member.id) do %>
      <%= attachment_image_tag post.member, :profile_image, :fill, 30, 30, format: 'jpeg', fallback: "no_image.jpg", size: "30x30" %><br>
      <%= post.member.account_name %>
    <% end %>
  　   <%= post.body %><br>
  　   @<%= post.address %>
      /ジャンル：<%= post.genre.name %>
      <%= time_ago_in_words(post.created_at) %> ago
      <%= link_to post_comment_path(post.id) do %>
        <i class="far fa-comment-dots"></i>
      <% end %>
    <% if current_member.id == post.member.id %>
      <%= link_to edit_post_path(post.id) do %>
        <i class="fas fa-wrench"></i>
      <% end %>
      <%= link_to post_path(post.id), method: :delete do %>
        <i class="far fa-trash-alt"></i>
      <% end %>
    <% else %>
      <% if post.requested_by?(current_member) %>
        <%= button_to "リクエストを取り消す", post_post_requests_path(post.id), method: :delete, remote: true %>
          <!--投稿に対するリクエストのなかでログインユーザのリクエストが承認されたかどうか-->
          <% if post.post_requests.find_by(member: current_member).is_accepted? %>
            Accepted!
          <% else %>
            Waiting acceptance...
          <% end %>
      <% else %>
        <%= button_to "リクエスト", post_post_requests_path(post.id), method: :post, remote: true %>
      <% end %>
    <% end %>
    <hr><br>
    </tr>
   <% end %>
   </div>
</section>

    <div id="map"></div>

<script>

let map

    function initMap(){
      geocoder = new google.maps.Geocoder()

      map = new google.maps.Map(document.getElementById('map'), {
          center: {lat: 39.68123620000001, lng:137.7671248},
          zoom: 5,
      });

      //each do をjs内で回すことで投稿ごとのデータを取得
      <% @posts.each do |post| %>
          (function(){
          var contentString = "住所：<%= post.address %>";

          var marker = new google.maps.Marker({
              position:{lat: <%= post.latitude %>, lng: <%= post.longitude %>},
              map: map,
              title: contentString
          });
          var infoWindow = new google.maps.InfoWindow({
              content: "<%= post.body %> by <a href='/members/<%= post.member.id %>'><%= post.member.account_name %></a><br><%= time_ago_in_words(post.created_at) %> ago"
          });
          //情報ウインドウを開くイベントアクション
          google.maps.event.addListener(marker, 'click', function() {
              infoWindow.open(map, marker);
          });

          })();
      <% end %>
      }



</script>

<script async defer src="https://maps.googleapis.com/maps/api/js?v=3.exp&key=<%= ENV['GOOGLE_API_KEY'] %>&callback=initMap">
</script>