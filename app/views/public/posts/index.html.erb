<div class="posts-index">
  <div class="search-form">
    <div class="genre-search-form field">
      <p class="control">
        <%= search_form_for @q do |f| %>
          <span class="select is-small">
            <%= f.collection_select :genre_id_eq, @genres, :id, :name, :include_blank => 'ğŸ” ã‚¸ãƒ£ãƒ³ãƒ«' %>
          </span>
          <%= f.submit "æ¤œç´¢", class: "button is-info is-small" %>
        <% end %>
      </p>
    </div>
    <div class="address-search-form field">
      <%= search_form_for @q do |f| %>
        <%= f.search_field :address_cont, placeholder: "ğŸ” å ´æ‰€", class: "is-small" %>
        <%= f.submit "æ¤œç´¢", class: "button is-info is-small" %>
      <% end %>
    </div>
  </div>
  <div class="columns is-desktop">
    <div class="timeline column">
      <h4>ä»Šæ—¥ã®ã¿ã‚“ãªã®å‹•ã</h4>
      <!--åœ°å›³ã¸ã®ã‚¢ãƒ³ã‚«ãƒ¼ãƒªãƒ³ã‚¯(æºå¸¯ã®ã¿)-->
      <p class="map-anchor button is-rounded is-hidden-tablet">
        <%= link_to "#map" do %>
          <i class="fas fa-chevron-circle-down"></i>Map
        <% end %>
      </p>
      <div class="timeline-content">
      <% unless @posts.any? %>
        <p>24æ™‚é–“ä»¥å†…ã®æŠ•ç¨¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>
      <% end %>
      <% @posts.each do |post| %>
        <article class="box media" style="margin-bottom: 0px; margin-top: 0px; border-radius: 0px;">
          <figure class="media-left is-square is-48-48" style="width: 15%;">
            <p class="image">
              <%= link_to member_path(post.member.id) do %>
                <%= attachment_image_tag post.member, :profile_image, :fill, 100, 100, format: 'jpeg', fallback: "no-prof-image.png", size: "20x20", style: "border-radius: 50%;" %><br>
              <% end %>
              <%= post.member.account_name %>
            </p>
          </figure>
          <div class="media-content">
            <div class="content">
              <p><%= post.body %><br>
                <i class="fas fa-map-marker-alt"></i>
              <small><%= post.address %></small><br>
                <i class="fas fa-tags"></i>
              <small><%= post.genre.name %></small>
              </p>
              <small>
                <%= link_to post_comment_path(post.id) do %>
                  <i class="far fa-comment-dots"></i> <%= post.post_comments.count %>ä»¶
                <% end %>
                <% if current_member.id == post.member.id %>
                  <%= link_to edit_post_path(post.id) do %>
                    <i class="fas fa-wrench"></i>
                  <% end %>
                  <%= link_to post_path(post.id), method: :delete do %>
                    <i class="far fa-trash-alt"></i>
                  <% end %>
                <% else %>
                  <!--<small class="request-btn" id="post_<%#= post.id %>">-->
                  <!--ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ™‚ã«è¡¨ç¤º-->
                  <% if post.requested_by?(current_member) %>
                    <%= link_to post_post_requests_path(post.id), method: :delete, remote: true do %>
                      <button class="button is-warning is-small">
                        <span class="icon">
                          <svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 0 24 24" width="24"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M12.99 9.18c0-.06.01-.12.01-.18 0-2.21-1.79-4-4-4-.06 0-.12.01-.18.01l4.17 4.17zm-6.1-3.56L4.27 3 3 4.27l2.62 2.62C5.23 7.5 5 8.22 5 9c0 2.21 1.79 4 4 4 .78 0 1.5-.23 2.11-.62L19.73 21 21 19.73l-8.62-8.62-5.49-5.49zM9 15c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4zm7.76-9.64l-1.68 1.69c.84 1.18.84 2.71 0 3.89l1.68 1.69c2.02-2.02 2.02-5.07 0-7.27zM20.07 2l-1.63 1.63c2.77 3.02 2.77 7.56 0 10.74L20.07 16c3.9-3.89 3.91-9.95 0-14z"/></svg>
                        </span>
                        <span>ã€€ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å–ã‚Šæ¶ˆã™</span>
                      </button><br>
                    <% end %>
                    <!--æŠ•ç¨¿ã«å¯¾ã™ã‚‹ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ãªã‹ã§ãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒæ‰¿èªã•ã‚ŒãŸã‹ã©ã†ã‹-->
                      <% if post.post_requests.find_by(member: current_member).is_accepted? %>
                        <strong>æ‰¿èªã•ã‚Œã¾ã—ãŸï¼</strong><br>
                        <%= link_to chat_path(post.member) ,class: "button is-info is-small" do %>
                          <i class="far fa-paper-plane">ã€€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ã‚ã†</i>
                        <% end %>
                      <% else %>
                        æ‰¿èªå¾…ã¡...
                      <% end %>
                  <% else %>
                  <!--æœªãƒªã‚¯ã‚¨ã‚¹ãƒˆæ™‚ã«è¡¨ç¤º-->
                    <%= link_to post_post_requests_path(post.id), method: :post, remote: true do %>
                      <button class="button is-primary is-small">
                        <span class="icon">
                          <svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 0 24 24" width="24"><path d="M0 0h24v24H0z" fill="none"/><circle cx="9" cy="9" r="4"/><path d="M9 15c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4zm7.76-9.64l-1.68 1.69c.84 1.18.84 2.71 0 3.89l1.68 1.69c2.02-2.02 2.02-5.07 0-7.27zM20.07 2l-1.63 1.63c2.77 3.02 2.77 7.56 0 10.74L20.07 16c3.9-3.89 3.91-9.95 0-14z"/></svg>
                        </span>
                        <span>ã€€ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ã‚‹</span>
                      </button>
                    <% end %>
                  <% end %>
                <!--</small>-->
              <% end %>
            </small>
          </div>
        </div>
        <div class="media-right is-size-7">
          <small><%= time_ago_in_words(post.created_at) %>å‰</small>
        </div>
      </article>
    <% end %>
    </div>
    </div>
    <div class="map-content column">
      <h4>ã¿ã‚“ãªã®å ´æ‰€</h4>
    <div id="map" class="column"></div>
    </div>
  </div>
</div>


<script>

var map

    function initMap(){
      geocoder = new google.maps.Geocoder()

      map = new google.maps.Map(document.getElementById('map'), {
          center: {lat: 39.68123620000001, lng:137.7671248},
          zoom: 5,
      });

      //each do ã‚’jså†…ã§å›ã™ã“ã¨ã§æŠ•ç¨¿ã”ã¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
      <% @posts.each do |post| %>
        //å–å¾—ä¸å¯ã®ä½ç½®æƒ…å ±ãŒæŠ•ç¨¿ã•ã‚ŒãŸéš›ã«åœ°å›³ãŒéè¡¨ç¤ºã«ãªã‚‹ã®ã‚’é˜²æ­¢
        <% if post.latitude != nil %>
          (function(){
          var contentString = "ä½æ‰€ï¼š<%= post.address %>";

          var marker = new google.maps.Marker({
              position:{lat: <%= post.latitude %>, lng: <%= post.longitude %>},
              map: map,
              title: contentString
          });
          var infoWindow = new google.maps.InfoWindow({
              content: "<%= post.body %> by <a href='/members/<%= post.member.id %>'><%= post.member.account_name %></a><br><%= time_ago_in_words(post.created_at) %>å‰"
          });
          //æƒ…å ±ã‚¦ã‚¤ãƒ³ãƒ‰ã‚¦ã‚’é–‹ãã‚¤ãƒ™ãƒ³ãƒˆã‚¢ã‚¯ã‚·ãƒ§ãƒ³
          google.maps.event.addListener(marker, 'click', function() {
              infoWindow.open(map, marker);
          });

          })();
        <% end %>
      <% end %>
      }



</script>

<script async defer src="https://maps.googleapis.com/maps/api/js?v=3.exp&key=<%= ENV['GOOGLE_API_KEY'] %>&callback=initMap">
</script>
